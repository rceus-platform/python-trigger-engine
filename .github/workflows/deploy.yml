name: Deploy App

on:
    push:
        branches:
            - main

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Deploy latest code
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.VM_HOST }}
                  username: ${{ secrets.VM_USER }}
                  key: ${{ secrets.VM_SSH_KEY }}
                  script: |
                      set -e

                      APP_NAME=${{ github.event.repository.name }}
                      APP_DIR=/opt/apps/$APP_NAME
                      SERVICE_NAME=$APP_NAME.service

                      echo "‚û° Deploying $APP_NAME"

                      cd $APP_DIR

                      echo "üì• Pulling code"
                      git pull origin main

                      echo "üì¶ Installing dependencies"
                      $APP_DIR/.venv/bin/pip install -r requirements.txt

                      if [ -f manage.py ]; then
                        echo "üß† Django detected"
                        $APP_DIR/.venv/bin/python manage.py migrate --noinput
                        $APP_DIR/.venv/bin/python manage.py collectstatic --noinput
                      fi

                      echo "üîÅ Restarting service"
                      sudo systemctl daemon-reload
                      sudo systemctl restart $SERVICE_NAME

                      echo "üåê Reloading nginx"
                      sudo systemctl reload nginx

                      echo "ü©∫ Verifying service"
                      sleep 2
                      sudo systemctl is-active --quiet $SERVICE_NAME

                      echo "‚úÖ Deploy completed successfully"
