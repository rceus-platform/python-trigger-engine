name: Deploy App

on:
    push:
        branches:
            - main

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Deploy latest code
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.VM_HOST }}
                  username: ${{ secrets.VM_USER }}
                  key: ${{ secrets.VM_SSH_KEY }}
                  script: |
                      APP_DIR=/opt/apps/${{ github.event.repository.name }}
                      SERVICE_NAME=${{ github.event.repository.name }}.service

                      cd $APP_DIR
                      git pull origin develop

                      source .venv/bin/activate
                      pip install -r requirements.txt

                      if [ -f manage.py ]; then
                        python manage.py migrate --noinput
                      fi

                      sudo systemctl daemon-reload
                      sudo systemctl restart $SERVICE_NAME
                      sudo systemctl reload nginx
