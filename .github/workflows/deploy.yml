name: Deploy App

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy latest code
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          envs: GITHUB_REPOSITORY,APP_SECRET_JSON_B64
          script: |
            set -e

            APP_NAME="$(basename $GITHUB_REPOSITORY)"
            APP_DIR="/opt/apps/$APP_NAME"
            SERVICE_NAME=$APP_NAME.service
            QCLUSTER_SERVICE_NAME=$APP_NAME-qcluster.service
            MANIFEST=$APP_DIR/codebuild/app.manifest.json
            SECRET_PATH="/opt/secrets/${APP_NAME}.json"

            echo "‚û° Injecting secrets for $APP_NAME"
            sudo mkdir -p /opt/secrets
            echo "$APP_SECRET_JSON_B64" \
              | base64 --decode \
              | sudo tee "$SECRET_PATH" > /dev/null
            sudo chown ubuntu:ubuntu "$SECRET_PATH"
            sudo chmod 600 "$SECRET_PATH"

            echo "‚û° Deploying $APP_NAME"

            cd $APP_DIR

            echo "üßπ Cleaning untracked files"
            git clean -fd
            git stash

            echo "üì• Pulling code"
            git pull origin main

            if [ ! -f "$MANIFEST" ]; then
              echo "‚ùå Missing manifest: $MANIFEST"
              exit 1
            fi

            WORKDIR=$(jq -r '.working_dir' "$MANIFEST")
            APP_WORKDIR="$APP_DIR/$WORKDIR"
            VENV="$APP_WORKDIR/.venv"

            echo "üì¶ Installing dependencies"
            $VENV/bin/pip install -r "$APP_WORKDIR/requirements.txt"

            if [ -f "$APP_WORKDIR/manage.py" ]; then
              echo "üß† Django detected"
              $VENV/bin/python "$APP_WORKDIR/manage.py" migrate --noinput
              $VENV/bin/python "$APP_WORKDIR/manage.py" collectstatic --noinput
              
              echo "‚öôÔ∏è Configuring qcluster service"
              cat <<EOF | sudo tee /etc/systemd/system/$QCLUSTER_SERVICE_NAME > /dev/null
            [Unit]
            Description=${APP_NAME} QCluster Worker
            After=network.target

            [Service]
            User=ubuntu
            WorkingDirectory=${APP_WORKDIR}
            UMask=0002
            Environment=APP_SECRET_JSON=${SECRET_PATH}
            Environment=DJANGO_SETTINGS_MODULE=trigger_engine.settings
            Environment=PYTHONPATH=${APP_WORKDIR}
            ExecStart=${VENV}/bin/python ${APP_WORKDIR}/manage.py qcluster
            Restart=always
            RestartSec=3

            [Install]
            WantedBy=multi-user.target
            EOF
            fi

            echo "üîÅ Restarting service"
            sudo systemctl daemon-reload
            sudo systemctl restart $SERVICE_NAME
            sudo systemctl enable --now $QCLUSTER_SERVICE_NAME
            sudo systemctl restart $QCLUSTER_SERVICE_NAME

            echo "üåê Reloading nginx"
            sudo systemctl reload nginx

            echo "ü©∫ Verifying service"
            sleep 2
            sudo systemctl is-active --quiet $SERVICE_NAME
            sudo systemctl is-active --quiet $QCLUSTER_SERVICE_NAME

            echo "‚úÖ Deploy completed successfully"
        env:
          APP_SECRET_JSON_B64: ${{ secrets.APP_SECRET_JSON_B64 }}
