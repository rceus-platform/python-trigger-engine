name: Create App on VM

on:
  workflow_dispatch:

jobs:
  create:
    runs-on: ubuntu-latest

    steps:
      - name: Provision app + secrets on VM
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          envs: GITHUB_REPOSITORY,APP_SECRET_JSON_B64
          script: |
            set -e

            APP_NAME="$(basename $GITHUB_REPOSITORY)"
            SECRET_PATH="/opt/secrets/${APP_NAME}.json"

            sudo mkdir -p /opt/secrets

            echo "$APP_SECRET_JSON_B64" \
              | base64 -d \
              | sudo tee "$SECRET_PATH" > /dev/null

            sudo chmod 600 "$SECRET_PATH"
            sudo chown root:root "$SECRET_PATH"

            sudo /opt/automation/create_app.sh "$APP_NAME"

            echo "âœ… App '$APP_NAME' provisioned successfully"
