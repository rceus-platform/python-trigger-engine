name: Create App on VM

on:
  workflow_dispatch:

jobs:
  create:
    runs-on: ubuntu-latest

    steps:
      - name: Provision app + secrets on VM
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          envs: GITHUB_REPOSITORY,APP_SECRET_JSON_B64
          script: |
            set -e
            APP_NAME="$(basename $GITHUB_REPOSITORY)"
            SECRET_PATH="/opt/secrets/${APP_NAME}.json"

            sudo mkdir -p /opt/secrets

            echo "$APP_SECRET_JSON_B64" \
              | base64 --decode \
              | sudo tee "$SECRET_PATH" > /dev/null

            sudo chown ubuntu:ubuntu "$SECRET_PATH"
            sudo chmod 600 "$SECRET_PATH"

            sudo /opt/automation/create_app.sh "$APP_NAME"

            # ---- CREATE SQLITE DB (ONE TIME) ----
            APP_DIR="/opt/apps/$APP_NAME"

            if [ -f "$APP_DIR/manage.py" ]; then
              echo "üóÑÔ∏è Creating SQLite DB via Django migrations"
              cd "$APP_DIR"
              source .venv/bin/activate
              python manage.py migrate --noinput
            fi
            # ------------------------------------
        env:
          APP_SECRET_JSON_B64: ${{ secrets.APP_SECRET_JSON_B64 }}
